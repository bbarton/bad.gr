// Generated by CoffeeScript 1.3.3
(function() {
  var TwitterStrategy, app, express, fetchUser, passport, port, redis, rtg, twitter;

  if (process.env.REDISTOGO_URL) {
    rtg = require('url').parse(process.env.REDISTOGO_URL);
    redis = require('redis').createClient(rtg.port, rtg.hostname);
    redis.auth(rtg.auth.split(':')[1]);
  } else {
    redis = require('redis').createClient();
  }

  express = require('express');

  twitter = require('twitter');

  app = express();

  passport = require('passport');

  TwitterStrategy = require('passport-twitter').Strategy;

  app.use(express.cookieParser());

  app.use(express.bodyParser());

  app.use(express.cookieSession({
    secret: process.env.COOKIE_SECRET
  }));

  app.use(passport.initialize());

  app.use(passport.session());

  app.use(express["static"](__dirname + '/static'));

  fetchUser = function(id, callback) {
    return redis.hgetall('user:' + id, function(err, user) {
      return callback(user || {
        id: null
      });
    });
  };

  app.use(function(req, res, next) {
    var cookie_slice, cookies, json;
    cookies = req.cookies['connect.sess'];
    if (cookies) {
      cookie_slice = cookies.substring(4, cookies.length).match(/(.*})\./)[1];
      json = JSON.parse(cookie_slice);
      if (json['oauth:twitter']) {
        req.session.oauth_twitter = json['oauth:twitter'];
      }
    }
    return next();
  });

  passport.serializeUser(function(user, done) {
    return done(null, user.id);
  });

  passport.deserializeUser(function(id, done) {
    return redis.hgetall('user:' + id, function(err, user) {
      return done(err, user);
    });
  });

  passport.use(new TwitterStrategy({
    consumerKey: process.env.TWITTER_CONSUMER_KEY,
    consumerSecret: process.env.TWITTER_CONSUMER_SECRET,
    callbackURL: 'http://127.0.0.1:3000/auth/twitter/callback'
  }, function(token, tokenSecret, profile, done) {
    return redis.get('twitter:' + profile.id, function(err, uid) {
      if (uid) {
        return redis.hgetall('user:' + uid, function(err, user) {
          return done(err, user);
        });
      } else {
        return redis.incr('users', function(err, num) {
          redis.set('twitter:' + profile.id, num);
          redis.hset('user:' + num, 'twitter', profile.id);
          redis.hset('user:' + num, 'id', num);
          return redis.hgetall('user:' + num, function(err, user) {
            return done(err, user);
          });
        });
      }
    });
  }));

  app.get('/user', function(req, res) {
    return fetchUser(req.session.passport.user, function(user) {
      return res.json(user);
    });
  });

  app.get('/auth/twitter', passport.authenticate('twitter'));

  app.get('/auth/twitter/callback', passport.authenticate('twitter', {
    failureRedirect: '/'
  }), function(req, res) {
    redis.hset('user:' + req.user.id, 'oauth:twitter_key', req.session['oauth_twitter'].oauth_token);
    redis.hset('user:' + req.user.id, 'oauth:twitter_secret', req.session['oauth_twitter'].oauth_token_secret);
    return res.redirect('/');
  });

  app.get('/post', function(req, res) {
    return fetchUser(req.session.passport.user, function(user) {
      var twit;
      if (user.id) {
        twit = new twitter({
          consumer_key: process.env.TWITTER_CONSUMER_KEY,
          consumer_secret: process.env.TWITTER_CONSUMER_SECRET,
          access_token_key: user['oauth:twitter_key'],
          access_token_secret: user['oauth:twitter_secret']
        });
        twit.updateStatus(req.params.message, function(rsp) {
          return console.log(rsp);
        });
        return res.json({
          success: true
        });
      } else {
        return res.json({
          success: false
        });
      }
    });
  });

  port = process.env.PORT || 3000;

  app.listen(port);

}).call(this);
